name: XRDP-macOS

on:
  workflow_dispatch:

jobs:
  macos-remote:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: ğŸ Update & Install Basic Tools
        run: |
          echo "ğŸ”§ Updating Homebrew..."
          brew update || true
          echo "ğŸ§© Installing essential tools..."
          brew install nmap hydra sqlmap john nikto metasploit || true

      - name: ğŸ‘¤ User Info
        run: |
          echo "Current macOS user: $(whoami)"
          echo "Home directory: $HOME"

      - name: ğŸ’¾ Check Swap
        run: |
          echo "âš™ï¸ macOS uses dynamic swap by default:"
          sysctl vm.swapusage

      - name: ğŸŒ Install & Connect Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "ğŸš€ Installing Tailscale..."
          brew install tailscale
          sudo tailscaled &
          sleep 5
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} \
                            --hostname=macos-remote-${GITHUB_RUN_ID} \
                            --ssh --accept-dns=true --accept-routes=true

      - name: ğŸ“¡ Get Tailscale IP
        run: |
          TS_IP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "ğŸ§­ Tailscale IP: $TS_IP"

      - name: ğŸ’» Print Remote Access Info
        run: |
          echo "======================================"
          echo "ğŸ macOS Remote Environment"
          echo "IP Address : ${{ env.TAILSCALE_IP }}"
          echo "Username   : $(whoami)"
          echo "Access via : SSH (Tailscale)"
          echo "======================================"
          echo "ğŸ‘‰ Command:"
          echo "ssh $(whoami)@${{ env.TAILSCALE_IP }}"
          echo "======================================"
          echo "ğŸ§° Installed Tools:"
          echo "- nmap, hydra, sqlmap, john, nikto, metasploit"
          echo "ğŸ’¬ macOS Ready âœ…"

      - name: ğŸ•“ Keep session alive
        run: |
          while true; do
            echo "[$(date)] macOS Active on ${{ env.TAILSCALE_IP }}"
            sleep 300
          done
